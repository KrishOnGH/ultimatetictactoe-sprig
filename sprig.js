// Borders
const borderhorizontal = "-";
const bordervertical = "|";
const bordercross = "/";

// Highlighted borders
const borderhorizontalRed = "[";
const borderverticalRed = "_";
const bordercrossRed = "]";

// Sprites that make up big O for boxes O has won
const owin1 = "2"
const owin2 = "3"
const owin3 = "4"
const owin4 = "5"
const owin5 = "6"
const owin6 = "7"
const owin7 = "8"
const owin8 = "9"

// Sprites that make up big X for boxes X has won
const xwin1 = "@"
const xwin2 = "#"
const xwin3 = "$"

// Sprites that make up big T for boxes that are tied
const draw1 = "*"
const draw2 = "("
const draw3 = ")"

// Empty, circle, and X variations of 9 squares

// Top
const tle = "a";
const tlc = "b";
const tlx = "c";
const tme = "d";
const tmc = "e";
const tmx = "f";
const tre = "g";
const trc = "h";
const trx = "i";

// Middle
const mle = "j";
const mlc = "k";
const mlx = "l";
const mme = "m";
const mmc = "n";
const mmx = "o";
const mre = "p";
const mrc = "q";
const mrx = "r";

// Bottom
const ble = "s";
const blc = "t";
const blx = "u";
const bme = "v";
const bmc = "w";
const bmx = "x";
const bre = "y";
const brc = "z";
const brx = "1";

// Empty, circle, and X variations of 9 highlighted squares

// Top
const tleh = "A";
const tlch = "B";
const tlxh = "C";
const tmeh = "D";
const tmch = "E";
const tmxh = "F";
const treh = "G";
const trch = "H";
const trxh = "I";

// Middle
const mleh = "J";
const mlch = "K";
const mlxh = "L";
const mmeh = "M";
const mmch = "N";
const mmxh = "O";
const mreh = "P";
const mrch = "Q";
const mrxh = "R";

// Bottom
const bleh = "S";
const blch = "T";
const blxh = "U";
const bmeh = "V";
const bmch = "W";
const bmxh = "X";
const breh = "Y";
const brch = "Z";
const brxh = "!";

// assign bitmap art to each sprite
setLegend(
  [ borderhorizontal, bitmap`
................
................
................
................
................
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
................
................
................
................
................`],
  [ bordervertical, bitmap`
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....`],
  [ bordercross, bitmap`
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
.....000000.....
.....000000.....
.....000000.....
.....000000.....
.....000000.....`],
  [ borderhorizontalRed, bitmap`
................
................
................
................
................
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
................
................
................
................
................`],
  [ borderverticalRed, bitmap`
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....`],
  [ bordercrossRed, bitmap`
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
.....333333.....
.....333333.....
.....333333.....
.....333333.....
.....333333.....`],
  [ owin1, bitmap`
................
..............77
............77..
..........77....
.........7......
........7.......
.......7........
......7.........
.....7..........
....7...........
...7............
...7............
..7.............
..7.............
.7..............
.7..............`],
  [ owin2, bitmap`
7777777777777777
................
................
................
................
................
................
................
................
................
................
................
................
................
................
................`],
  [ owin3, bitmap`
................
77..............
..77............
....77..........
......7.........
.......7........
........7.......
.........7......
..........7.....
...........7....
............7...
............7...
.............7..
.............7..
..............7.
..............7.`],
  [ owin4, bitmap`
...............7
...............7
...............7
...............7
...............7
...............7
...............7
...............7
...............7
...............7
...............7
...............7
...............7
...............7
...............7
...............7`],
  [ owin5, bitmap`
..............7.
..............7.
.............7..
.............7..
............7...
............7...
...........7....
..........7.....
.........7......
........7.......
.......7........
......7.........
....77..........
..77............
77..............
................`],
  [ owin6, bitmap`
................
................
................
................
................
................
................
................
................
................
................
................
................
................
................
7777777777777777`], 
  [ owin7, bitmap`
.7..............
.7..............
..7.............
..7.............
...7............
...7............
....7...........
.....7..........
......7.........
.......7........
........7.......
.........7......
..........77....
............77..
..............77
................`],
  [ owin8, bitmap`
7...............
7...............
7...............
7...............
7...............
7...............
7...............
7...............
7...............
7...............
7...............
7...............
7...............
7...............
7...............
7...............`],
  [ xwin1, bitmap`
9...............
.9..............
..9.............
...9............
....9...........
.....9..........
......9.........
.......9........
........9.......
.........9......
..........9.....
...........9....
............9...
.............9..
..............9.
...............9`],
  [ xwin2, bitmap`
...............9
..............9.
.............9..
............9...
...........9....
..........9.....
.........9......
........9.......
.......9........
......9.........
.....9..........
....9...........
...9............
..9.............
.9..............
9...............`],
  [ xwin3, bitmap`
9..............9
.9............9.
..9..........9..
...9........9...
....9......9....
.....9....9.....
......9..9......
.......99.......
.......99.......
......9..9......
.....9....9.....
....9......9....
...9........9...
..9..........9..
.9............9.
9..............9`],
  [ draw1, bitmap`
4444444444444444
4444444444444444
................
................
................
................
................
................
................
................
................
................
................
................
................
................`],
  [ draw2, bitmap`
4444444444444444
4444444444444444
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......`],
  [ draw3, bitmap`
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......
.......44.......`],
  [ tle, bitmap`
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
0000000000000000`],
  [ tlc, bitmap`
...............0
...............0
......0000.....0
.....0....0....0
....0......0...0
...0........0..0
..0..........0.0
..0..........0.0
..0..........0.0
..0..........0.0
...0........0..0
....0......0...0
.....0....0....0
......0000.....0
...............0
0000000000000000`],
  [ tlx, bitmap`
...............0
...............0
..0..........0.0
...0........0..0
....0......0...0
.....0....0....0
......0..0.....0
.......00......0
.......00......0
......0..0.....0
.....0....0....0
....0......0...0
...0........0..0
..0..........0.0
...............0
0000000000000000`],
  [ tme, bitmap`
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0000000000000000`],
  [ tmc, bitmap`
0..............0
0..............0
0.....0000.....0
0....0....0....0
0...0......0...0
0..0........0..0
0.0..........0.0
0.0..........0.0
0.0..........0.0
0.0..........0.0
0..0........0..0
0...0......0...0
0....0....0....0
0.....0000.....0
0..............0
0000000000000000`],
  [ tmx, bitmap`
0..............0
0..............0
0.0..........0.0
0..0........0..0
0...0......0...0
0....0....0....0
0.....0..0.....0
0......00......0
0......00......0
0.....0..0.....0
0....0....0....0
0...0......0...0
0..0........0..0
0.0..........0.0
0..............0
0000000000000000`],
  [ tre, bitmap`
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0000000000000000`],
  [ trc, bitmap`
0...............
0...............
0.....0000......
0....0....0.....
0...0......0....
0..0........0...
0.0..........0..
0.0..........0..
0.0..........0..
0.0..........0..
0..0........0...
0...0......0....
0....0....0.....
0.....0000......
0...............
0000000000000000`],
  [ trx, bitmap`
0...............
0...............
0.0..........0..
0..0........0...
0...0......0....
0....0....0.....
0.....0..0......
0......00.......
0......00.......
0.....0..0......
0....0....0.....
0...0......0....
0..0........0...
0.0..........0..
0...............
0000000000000000`],
  [ mle, bitmap`
0000000000000000
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
0000000000000000`],
  [ mlc, bitmap`
0000000000000000
...............0
......0000.....0
.....0....0....0
....0......0...0
...0........0..0
..0..........0.0
..0..........0.0
..0..........0.0
..0..........0.0
...0........0..0
....0......0...0
.....0....0....0
......0000.....0
...............0
0000000000000000`],
  [ mlx, bitmap`
0000000000000000
...............0
..0..........0.0
...0........0..0
....0......0...0
.....0....0....0
......0..0.....0
.......00......0
.......00......0
......0..0.....0
.....0....0....0
....0......0...0
...0........0..0
..0..........0.0
...............0
0000000000000000`],
  [ mme, bitmap`
0000000000000000
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0000000000000000`],
  [ mmc, bitmap`
0000000000000000
0..............0
0.....0000.....0
0....0....0....0
0...0......0...0
0..0........0..0
0.0..........0.0
0.0..........0.0
0.0..........0.0
0.0..........0.0
0..0........0..0
0...0......0...0
0....0....0....0
0.....0000.....0
0..............0
0000000000000000`],
  [ mmx, bitmap`
0000000000000000
0..............0
0.0..........0.0
0..0........0..0
0...0......0...0
0....0....0....0
0.....0..0.....0
0......00......0
0......00......0
0.....0..0.....0
0....0....0....0
0...0......0...0
0..0........0..0
0.0..........0.0
0..............0
0000000000000000`],
  [ mre, bitmap`
0000000000000000
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0000000000000000`],
  [ mrc, bitmap`
0000000000000000
0...............
0.....0000......
0....0....0.....
0...0......0....
0..0........0...
0.0..........0..
0.0..........0..
0.0..........0..
0.0..........0..
0..0........0...
0...0......0....
0....0....0.....
0.....0000......
0...............
0000000000000000`],
  [ mrx, bitmap`
0000000000000000
0...............
0.0..........0..
0..0........0...
0...0......0....
0....0....0.....
0.....0..0......
0......00.......
0......00.......
0.....0..0......
0....0....0.....
0...0......0....
0..0........0...
0.0..........0..
0...............
0000000000000000`],
  [ ble, bitmap`
0000000000000000
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0
...............0`],
  [ blc, bitmap`
0000000000000000
...............0
......0000.....0
.....0....0....0
....0......0...0
...0........0..0
..0..........0.0
..0..........0.0
..0..........0.0
..0..........0.0
...0........0..0
....0......0...0
.....0....0....0
......0000.....0
...............0
...............0`],
  [ blx, bitmap`
0000000000000000
...............0
..0..........0.0
...0........0..0
....0......0...0
.....0....0....0
......0..0.....0
.......00......0
.......00......0
......0..0.....0
.....0....0....0
....0......0...0
...0........0..0
..0..........0.0
...............0
...............0`],
  [ bme, bitmap`
0000000000000000
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0
0..............0`],
  [ bmc, bitmap`
0000000000000000
0..............0
0.....0000.....0
0....0....0....0
0...0......0...0
0..0........0..0
0.0..........0.0
0.0..........0.0
0.0..........0.0
0.0..........0.0
0..0........0..0
0...0......0...0
0....0....0....0
0.....0000.....0
0..............0
0..............0`],
  [ bmx, bitmap`
0000000000000000
0..............0
0.0..........0.0
0..0........0..0
0...0......0...0
0....0....0....0
0.....0..0.....0
0......00......0
0......00......0
0.....0..0.....0
0....0....0....0
0...0......0...0
0..0........0..0
0.0..........0.0
0..............0
0..............0`],
  [ bre, bitmap`
0000000000000000
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............
0...............`],
  [ brc, bitmap`
0000000000000000
0...............
0.....0000......
0....0....0.....
0...0......0....
0..0........0...
0.0..........0..
0.0..........0..
0.0..........0..
0.0..........0..
0..0........0...
0...0......0....
0....0....0.....
0.....0000......
0...............
0...............`],
  [ brx, bitmap`
0000000000000000
0...............
0.0..........0..
0..0........0...
0...0......0....
0....0....0.....
0.....0..0......
0......00.......
0......00.......
0.....0..0......
0....0....0.....
0...0......0....
0..0........0...
0.0..........0..
0...............
0...............`],
  [ tleh, bitmap`
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
3333333333333333`],
  [ tlch, bitmap`
...............3
...............3
......3333.....3
.....3....3....3
....3......3...3
...3........3..3
..3..........3.3
..3..........3.3
..3..........3.3
..3..........3.3
...3........3..3
....3......3...3
.....3....3....3
......3333.....3
...............3
3333333333333333`],
  [ tlxh, bitmap`
...............3
...............3
..3..........3.3
...3........3..3
....3......3...3
.....3....3....3
......3..3.....3
.......33......3
.......33......3
......3..3.....3
.....3....3....3
....3......3...3
...3........3..3
..3..........3.3
...............3
3333333333333333`],
  [ tmeh, bitmap`
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3333333333333333`],
  [ tmch, bitmap`
3..............3
3..............3
3.....3333.....3
3....3....3....3
3...3......3...3
3..3........3..3
3.3..........3.3
3.3..........3.3
3.3..........3.3
3.3..........3.3
3..3........3..3
3...3......3...3
3....3....3....3
3.....3333.....3
3..............3
3333333333333333`],
  [ tmxh, bitmap`
3..............3
3..............3
3.3..........3.3
3..3........3..3
3...3......3...3
3....3....3....3
3.....3..3.....3
3......33......3
3......33......3
3.....3..3.....3
3....3....3....3
3...3......3...3
3..3........3..3
3.3..........3.3
3..............3
3333333333333333`],
  [ treh, bitmap`
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3333333333333333`],
  [ trch, bitmap`
3...............
3...............
3.....3333......
3....3....3.....
3...3......3....
3..3........3...
3.3..........3..
3.3..........3..
3.3..........3..
3.3..........3..
3..3........3...
3...3......3....
3....3....3.....
3.....3333......
3...............
3333333333333333`],
  [ trxh, bitmap`
3...............
3...............
3.3..........3..
3..3........3...
3...3......3....
3....3....3.....
3.....3..3......
3......33.......
3......33.......
3.....3..3......
3....3....3.....
3...3......3....
3..3........3...
3.3..........3..
3...............
3333333333333333`],
  [ mleh, bitmap`
3333333333333333
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
3333333333333333`],
  [ mlch, bitmap`
3333333333333333
...............3
......3333.....3
.....3....3....3
....3......3...3
...3........3..3
..3..........3.3
..3..........3.3
..3..........3.3
..3..........3.3
...3........3..3
....3......3...3
.....3....3....3
......3333.....3
...............3
3333333333333333`],
  [ mlxh, bitmap`
3333333333333333
...............3
..3..........3.3
...3........3..3
....3......3...3
.....3....3....3
......3..3.....3
.......33......3
.......33......3
......3..3.....3
.....3....3....3
....3......3...3
...3........3..3
..3..........3.3
...............3
3333333333333333`],
  [ mmeh, bitmap`
3333333333333333
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3333333333333333`],
  [ mmch, bitmap`
3333333333333333
3..............3
3.....3333.....3
3....3....3....3
3...3......3...3
3..3........3..3
3.3..........3.3
3.3..........3.3
3.3..........3.3
3.3..........3.3
3..3........3..3
3...3......3...3
3....3....3....3
3.....3333.....3
3..............3
3333333333333333`],
  [ mmxh, bitmap`
3333333333333333
3..............3
3.3..........3.3
3..3........3..3
3...3......3...3
3....3....3....3
3.....3..3.....3
3......33......3
3......33......3
3.....3..3.....3
3....3....3....3
3...3......3...3
3..3........3..3
3.3..........3.3
3..............3
3333333333333333`],
  [ mreh, bitmap`
3333333333333333
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3333333333333333`],
  [ mrch, bitmap`
3333333333333333
3...............
3.....3333......
3....3....3.....
3...3......3....
3..3........3...
3.3..........3..
3.3..........3..
3.3..........3..
3.3..........3..
3..3........3...
3...3......3....
3....3....3.....
3.....3333......
3...............
3333333333333333`],
  [ mrxh, bitmap`
3333333333333333
3...............
3.3..........3..
3..3........3...
3...3......3....
3....3....3.....
3.....3..3......
3......33.......
3......33.......
3.....3..3......
3....3....3.....
3...3......3....
3..3........3...
3.3..........3..
3...............
3333333333333333`],
  [ bleh, bitmap`
3333333333333333
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3
...............3`],
  [ blch, bitmap`
3333333333333333
...............3
......3333.....3
.....3....3....3
....3......3...3
...3........3..3
..3..........3.3
..3..........3.3
..3..........3.3
..3..........3.3
...3........3..3
....3......3...3
.....3....3....3
......3333.....3
...............3
...............3`],
  [ blxh, bitmap`
3333333333333333
...............3
..3..........3.3
...3........3..3
....3......3...3
.....3....3....3
......3..3.....3
.......33......3
.......33......3
......3..3.....3
.....3....3....3
....3......3...3
...3........3..3
..3..........3.3
...............3
...............3`],
  [ bmeh, bitmap`
3333333333333333
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3
3..............3`],
  [ bmch, bitmap`
3333333333333333
3..............3
3.....3333.....3
3....3....3....3
3...3......3...3
3..3........3..3
3.3..........3.3
3.3..........3.3
3.3..........3.3
3.3..........3.3
3..3........3..3
3...3......3...3
3....3....3....3
3.....3333.....3
3..............3
3..............3`],
  [ bmxh, bitmap`
3333333333333333
3..............3
3.3..........3.3
3..3........3..3
3...3......3...3
3....3....3....3
3.....3..3.....3
3......33......3
3......33......3
3.....3..3.....3
3....3....3....3
3...3......3...3
3..3........3..3
3.3..........3.3
3..............3
3..............3`],
  [ breh, bitmap`
3333333333333333
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............
3...............`],
  [ brch, bitmap`
3333333333333333
3...............
3.....3333......
3....3....3.....
3...3......3....
3..3........3...
3.3..........3..
3.3..........3..
3.3..........3..
3.3..........3..
3..3........3...
3...3......3....
3....3....3.....
3.....3333......
3...............
3...............`],
  [ brxh, bitmap`
3333333333333333
3...............
3.3..........3..
3..3........3...
3...3......3....
3....3....3.....
3.....3..3......
3......33.......
3......33.......
3.....3..3......
3....3....3.....
3...3......3....
3..3........3...
3.3..........3..
3...............
3...............`]
);

let game = 0;
const screens = [
  map`
................
................
................
................
................
................
................
................
................
................
................
................
................`,
  map`
.-----------.
|adg|adg|adg|
|jmp|jmp|jmp|
|svy|svy|svy|
|---/---/---|
|adg|adg|adg|
|jmp|jmp|jmp|
|svy|svy|svy|
|---/---/---|
|adg|adg|adg|
|jmp|jmp|jmp|
|svy|svy|svy|
.-----------.`,
  map`
................
................
................
................
................
................
................
................
................
................
................
................
................`,
];

// Add text to start screen
addText("Super Tic Tac Toe!", { 
  x: 1,
  y: 7,
  color: color`3`
})
addText("Press J to Start", { 
  x: 2,
  y: 9,
  color: color`1`
})

// Save original game screen to use when restarting game
const originalScreen = screens[1];

// Render start screen
setMap(screens[game]);

// Basic screen control functions
function upperCaseCharacter(char) {
  if (char != '1') {
    char = char.toUpperCase()
  } else { 
    char = '!'
  }

  return char
}

function lowerCaseCharacter(char) {
  if (char != '!') {
    char = char.toLowerCase()
  } else { 
    char = '1'
  }

  return char
}

function setSprite(x, y, newsprite) {
  x -= 1;
  y -= 1;

  // Determine which 3x3 board we are in
  const boardX = Math.floor(x / 3);
  const boardY = Math.floor(y / 3);

  // Determine the local position within the 3x3 board
  const localX = x % 3;
  const localY = y % 3;

  // Adjust y for the offset and the borders
  let adjustedY = 1 + boardY * 4 + localY +1;

  // Adjust x for the offset
  let adjustedX = 1 + boardX * 4 + localX;

  // Split the game map into rows
  const rows = screens[game].split('\n');

  // Update the map with the new sprite
  rows[adjustedY] = 
    rows[adjustedY].slice(0, adjustedX) +
    newsprite +
    rows[adjustedY].slice(adjustedX + 1);

  // Join the rows back into a single string
  screens[game] = rows.join('\n');
  setMap(screens[game]);
}

function getSprite(x, y) {
  x -= 1;
  y -= 1;

  // Determine which 3x3 board we are in
  const boardX = Math.floor(x / 3);
  const boardY = Math.floor(y / 3);

  // Determine the local position within the 3x3 board
  const localX = x % 3;
  const localY = y % 3;

  // Adjust y for the offset and the borders
  let adjustedY = 1 + boardY * 4 + localY + 1;

  // Adjust x for the offset
  let adjustedX = 1 + boardX * 4 + localX;

  // Split the game map into rows
  const rows = screens[game].split('\n');

  // Return the sprite at the calculated position
  return rows[adjustedY][adjustedX];
}

// Selection highlighting, win/lose/draw, and X/O render functions
function highlightSquare(x, y) {
  // Set sprite on given coordinates as upper case version of itself, this only works on a-z sprites and the 1 sprite, which become A-Z and !
  setSprite(x, y, upperCaseCharacter(getSprite(x, y)))
}

function highlightBox(boxx, boxy) {
  function highlight(x, y, highlightedSprite) {
    clearTile(x, y)
    addSprite(x, y, highlightedSprite)
  }

  // Highlight border on each side unless the side is on the edge of the board.
  if (boxy != 1) {
    if (boxx != 1) {
      highlight(4*(boxx-1), 4*(boxy-1), ']')
    }
    highlight(4*(boxx-1)+1, 4*(boxy-1), '[')
    highlight(4*(boxx-1)+2, 4*(boxy-1), '[')
    highlight(4*(boxx-1)+3, 4*(boxy-1), '[')
    if (boxx != 3) {
      highlight(4*(boxx-1)+4, 4*(boxy-1), ']')
    }
  }
  if (boxy != 3) {
    if (boxx != 1) {
      highlight(4*(boxx-1), 4*(boxy-1)+4, ']')
    }
    highlight(4*(boxx-1)+1, 4*(boxy-1)+4, '[')
    highlight(4*(boxx-1)+2, 4*(boxy-1)+4, '[')
    highlight(4*(boxx-1)+3, 4*(boxy-1)+4, '[')
    if (boxx != 3) {
      highlight(4*(boxx-1)+4, 4*(boxy-1)+4, ']')
    }
  }
  if (boxx != 1) {
    if (boxy != 1) {
      highlight(4*(boxx-1), 4*(boxy-1), ']')
    }
    highlight(4*(boxx-1), 4*(boxy-1)+1, '_')
    highlight(4*(boxx-1), 4*(boxy-1)+2, '_')
    highlight(4*(boxx-1), 4*(boxy-1)+3, '_')
    if (boxy != 3) {
      highlight(4*(boxx-1), 4*(boxy-1)+4, ']')
    }
  }
  if (boxx != 3) {
    if (boxy != 1) {
      highlight(4*(boxx-1)+4, 4*(boxy-1), ']')
    }
    highlight(4*(boxx-1)+4, 4*(boxy-1)+1, '_')
    highlight(4*(boxx-1)+4, 4*(boxy-1)+2, '_')
    highlight(4*(boxx-1)+4, 4*(boxy-1)+3, '_')
    if (boxy != 3) {
      highlight(4*(boxx-1)+4, 4*(boxy-1)+4, ']')
    }
  }
}

function unHighlight() {
  for (let x = 1; x < 10; x++) {
    for (let y = 1; y < 10; y++) {
      // Reset every sprite in the game from A-Z and ! to a-z and 1 (non-red versions of themselves) 
      setSprite(x, y, lowerCaseCharacter(getSprite(x, y)))
    }
  }
}

function setSquareValue(x, y, circleOrX) {
  const charstr='abcdefghijklmnopqrstuvwxyz1ABCDEFGHIJKLMNOPQRSTUVWXYz!'
  const empty='adgjmpsvyADGJMPSVY'
  let value = charstr.indexOf(getSprite(x, y))
  const xgrid = Math.ceil(x / 3);
  const ygrid = Math.ceil(y / 3);

  // Check if given square is not already an X or O
  if (empty.includes(charstr[value])) {
    // Box index of the box containing given square
    gridpos = ygrid*3-3+xgrid
    
    if (circleOrX == 'circle') {
      // Circle version of a square is one higher on the alphabet than the tile
      value += 1

      // Update grid
      grid[gridpos-1][ ((y - (ygrid-1)*3) -1) * 3 + (x - (xgrid-1)*3) - 1 ] = 1
    } 
    
    else if (circleOrX == 'x') {
      // Circle version of a square is one higher on the alphabet than the tile
      value += 2

      // Update grid
      grid[gridpos-1][ ((y - (ygrid-1)*3) -1) * 3 + (x - (xgrid-1)*3) -1 ] = 2
    }

    // Update sprite
    setSprite(x, y, charstr[value])
  }
}

function setBoxValue(gridpos, value) {
  let squarePositions = []
  const gridx = (gridpos-1) % 3 + 1;
  const gridy = Math.floor((gridpos-1) / 3) + 1;

  // Find all square coordinates inside box
  for (let y = (gridy*3-2); y < gridy*3+1; y++) {
    for (let x = (gridx*3-2); x < gridx*3+1; x++) {
      squarePositions.push([x, y])
    }
  }

  if (value == 0) {
    // Render T by mapping the 9 sprites that make it up onto the 9 tiles of the box
    setSprite(squarePositions[0][0], squarePositions[0][1], '*')
    setSprite(squarePositions[1][0], squarePositions[1][1], '(')
    setSprite(squarePositions[2][0], squarePositions[2][1], '*')
    setSprite(squarePositions[3][0], squarePositions[3][1], '.')
    setSprite(squarePositions[4][0], squarePositions[4][1], ')')
    setSprite(squarePositions[5][0], squarePositions[5][1], '.')
    setSprite(squarePositions[6][0], squarePositions[6][1], '.')
    setSprite(squarePositions[7][0], squarePositions[7][1], ')')
    setSprite(squarePositions[8][0], squarePositions[8][1], '.')
  } else if (value == 1) {
    // Render O by mapping the 9 sprites that make it up onto the 9 tiles of the box
    setSprite(squarePositions[0][0], squarePositions[0][1], '2')
    setSprite(squarePositions[1][0], squarePositions[1][1], '3')
    setSprite(squarePositions[2][0], squarePositions[2][1], '4')
    setSprite(squarePositions[3][0], squarePositions[3][1], '9')
    setSprite(squarePositions[4][0], squarePositions[4][1], '.')
    setSprite(squarePositions[5][0], squarePositions[5][1], '5')
    setSprite(squarePositions[6][0], squarePositions[6][1], '8')
    setSprite(squarePositions[7][0], squarePositions[7][1], '7')
    setSprite(squarePositions[8][0], squarePositions[8][1], '6')
  } else if (value == 2) {
    // Render X by mapping the 9 sprites that make it up onto the 9 tiles of the box
    setSprite(squarePositions[0][0], squarePositions[0][1], '@')
    setSprite(squarePositions[1][0], squarePositions[1][1], '.')
    setSprite(squarePositions[2][0], squarePositions[2][1], '#')
    setSprite(squarePositions[3][0], squarePositions[3][1], '.')
    setSprite(squarePositions[4][0], squarePositions[4][1], '$')
    setSprite(squarePositions[5][0], squarePositions[5][1], '.')
    setSprite(squarePositions[6][0], squarePositions[6][1], '#')
    setSprite(squarePositions[7][0], squarePositions[7][1], '.')
    setSprite(squarePositions[8][0], squarePositions[8][1], '@')
  }
}

function win(player) {
  // Reset gameboard so screen restarts when player chooses to play again
  screens[1] = originalScreen

  // Add text for end screen in winning scenario
  addText(player + " Wins!", { 
    x: 6,
    y: 7,
    color: color`9`
  })
  addText("Press J for Menu", { 
    x: 2,
    y: 9,
    color: color`1`
  })
  game = 2

  // Render end screen
  setMap(screens[game])
}

function draw() {
  // Reset gameboard so screen restarts when player chooses to play again
  screens[1] = originalScreen

  // Add text for end screen in draw scenario
  addText("Draw", { 
    x: 8,
    y: 7,
    color: color`0`
  })
  addText("Press J for Menu", { 
    x: 2,
    y: 9,
    color: color`1`
  })
  game = 2

  // Render end screen
  setMap(screens[game])
}

// Game state and response algorithm functions
function checkWinBox(gridpos) {
  // Calculate the 3x3 grid squares
  let squares = grid[gridpos-1]

  // Neccesary tiles placed for all possible ways to win (8)
  let winSetups = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]]
  
  // Tiles placed for X and O
  let oSquares = []
  let xSquares = []
  // Check box's grid to add to O and X tile arrays accordingly
  for (let i = 0; i < 9; i++) {
    if (squares[i] == 1) {
      oSquares.push(i)
    } else if (squares[i] == 2) {
      xSquares.push(i)
    }
  }

  // Loop through to check every possible win setup for X and O
  for (let i = 0; i < 8; i++) {
    // Counter to see min. number of tiles they have to place to win using current setup
    let winSetup = winSetups[i]
    let oSquaresRemaining = 3
    let xSquaresRemaining = 3

    // Loop to update counter
    for (let j = 0; j < 3; j++) {
      if (oSquares.includes(winSetup[j])) {
        oSquaresRemaining--
      } else if (xSquares.includes(winSetup[j])) {
        xSquaresRemaining--
      }
    }

    // If they need to place no more tiles to win using the setup (which means they won), return 1 for O and 2 for X
    if (oSquaresRemaining == 0) {
      return 1 // 1 means o wins
    } else if (xSquaresRemaining == 0) {
      return 2 // 2 means x wins
    }
  }

  // If nothing has been returned yet, check if draw (by all tiles being occupied with no win) else given box is not finished
  if (xSquares.length + oSquares.length > 8) {
    return 0 // 0 means draw
  } else {
    return 3 // 3 means unfinished box
  }
}

function checkWinBoard() {
  // Neccesary boxes won for all possible ways to win (8)
  let winSetups = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]]

  // Boxes won X and O
  let oBoxes = []
  let xBoxes = []
  // Check box's grid to add to O and X tile arrays accordingly
  for (let i = 0; i < 9; i++) {
    if (checkWinBox(i+1) == 1) {
      oBoxes.push(i)
    } 
    else if (checkWinBox(i+1) == 2) {
      xBoxes.push(i)
    }
  }
  
  // Loop through to check every possible win setup for X and O
  for (let i = 0; i < 8; i++) {
    // Counter to see min. number of boxes they have to win to win full board using current setup
    let winSetup = winSetups[i]
    let oBoxesRemaining = 3
    let xBoxesRemaining = 3
    
    // Loop to update counter
    for (let j = 0; j < 3; j++) {
      if (oBoxes.includes(winSetup[j])) {
        oBoxesRemaining--
      } else if (xBoxes.includes(winSetup[j])) {
        xBoxesRemaining--
      }
    }
    
    // If they need to place no more tiles to win using the setup (which means they won), return 1 for O and 2 for X
    if (oBoxesRemaining == 0) {
      return 1 // 1 means o wins
    } else if (xBoxesRemaining == 0) {
      return 2 // 2 means x wins
    }
  }
  
  // If nothing has been returned yet, check if draw (by all tiles being occupied with no win) else given box is not finished
  if (xBoxes.length + oBoxes.length > 8) {
    return 0 // 0 means draw
  } else {
    return 3 // 3 means unfinished board
  }
}

// Main variables
let highlightedX // Selected box's x coordinate
let highlightedY // Selected box's y coordinate
let squareX // Selected square's x coordinate
let squareY // Selected square's y coordinate
let selectingSquare // If player is selecting box or square
let canPlace // False if bot is currently responding
let locked // If player is locked to a box
let grid // Grid representing state of board
let player // Symbol of player (X or O)

// Input handlers for WASD movement, menu, game, and win screen toggle, box and square selection, and X/O placement
onInput("w", () => {
  if (game == 1) {
    if (selectingSquare && squareY > 1) {
      unHighlight();
      squareY--;
      highlightSquare(highlightedX * 3 - 3 + squareX, highlightedY * 3 - 3 + squareY);
    } else if (!selectingSquare && highlightedY > 1) {
      unHighlight();
      highlightedY--;
      highlightBox(highlightedX, highlightedY);
    }
  }
});

onInput("a", () => {
  if (game == 1) {
    if (selectingSquare && squareX > 1) {
      unHighlight();
      squareX--;
      highlightSquare(highlightedX * 3 - 3 + squareX, highlightedY * 3 - 3 + squareY);
    } else if (!selectingSquare && highlightedX > 1) {
      unHighlight();
      highlightedX--;
      highlightBox(highlightedX, highlightedY);
    }
  }
});

onInput("s", () => {
  if (game == 1) {
    if (selectingSquare && squareY < 3) {
      unHighlight();
      squareY++;
      highlightSquare(highlightedX * 3 - 3 + squareX, highlightedY * 3 - 3 + squareY);
    } else if (!selectingSquare && highlightedY < 3) {
      unHighlight();
      highlightedY++;
      highlightBox(highlightedX, highlightedY);
    }
  }
});

onInput("d", () => {
  if (game == 1) {
    if (selectingSquare && squareX < 3) {
      unHighlight();
      squareX++;
      highlightSquare(highlightedX * 3 - 3 + squareX, highlightedY * 3 - 3 + squareY);
    } else if (!selectingSquare && highlightedX < 3) {
      unHighlight();
      highlightedX++;
      highlightBox(highlightedX, highlightedY);
    }
  }
});

onInput("i", () => {
  if (game == 1) {
    if (!locked) {
      squareX = 2;
      squareY = 2;
      let gridpos = (highlightedY - 1) * 3 + highlightedX;
      console.log(gridpos)
      console.log(checkWinBox(gridpos) == 3)
      if (!selectingSquare && checkWinBox(gridpos) == 3) {
        selectingSquare = true
        unHighlight();
        highlightSquare(highlightedX * 3 - 3 + squareX, highlightedY * 3 - 3 + squareY);
      } else if (selectingSquare) {
        selectingSquare = false
        unHighlight();
        highlightBox(highlightedX, highlightedY);
      }
    }
  }
});

onInput("l", () => {
  if (game == 1) {
    if (selectingSquare && canPlace) {
      const x = highlightedX * 3 - 3 + squareX
      const y = highlightedY * 3 - 3 + squareY
      const charstr='abcdefghijklmnaopqrstuvwxyz1ABCDEFGHIJKLMNAOPQRSTUVWXYZ!'
      const empty='adgjmpsvyADGJMPSVY'
      let value = charstr.indexOf(getSprite(x, y))
  
      if (empty.includes(charstr[value])) {
        canPlace = false;
        setSquareValue(x, y, player == 'o' ? 'circle' : 'x')
  
        // Update box of player's move for win, lose, or draw
        let gridpos = (highlightedY - 1) * 3 + highlightedX;
        let status = checkWinBox(gridpos)
        setBoxValue(gridpos, status)

        // Check if game over
        if (checkWinBoard() == 2) {win('X')}
        else if (checkWinBoard() == 1) {win('O')}
        else if (checkWinBoard() == 0) {draw()}

        // Lock player to corresponding box of square
        locked = true
        let correspondingGridpos = (squareY - 1) * 3 + squareX;
        if (checkWinBox(correspondingGridpos) != 3) {locked = false}
    
        // Set highlighted box or square depending on if player is locked
        if (!locked) {
          selectingSquare=false 
          
          highlightedX = 2
          highlightedY = 2
          squareX = 2
          squareY = 2      
          
          unHighlight()
          highlightBox(highlightedX, highlightedY)
        } else {
          selectingSquare=true
                                        
          highlightedX = (correspondingGridpos-1) % 3 + 1;
          highlightedY = Math.floor((correspondingGridpos-1)/3) + 1;
          squareX = correspondingGridpos % 3 + 1;
          squareY = Math.floor(correspondingGridpos / 3) + 1;
          
          let availableOptions = 0
          for (let i = 0; i < 9; i++) {
            if (grid[gridpos - 1][i] === 0) {
              availableOptions++
              squareX = i % 3 + 1;
              squareY = Math.floor(i / 3) + 1;
            }
          }
          if (availableOptions > 1) {
            squareX = 2
            squareY = 2
          }
      
          unHighlight()  
          highlightSquare(highlightedX * 3 - 3 + squareX, highlightedY * 3 - 3 + squareY);
        }

        player = player == 'o' ? 'x' : 'o'
        canPlace = true;
      }
    }
  }
});

onInput("j", () => {
  if (game == 0) {
    game = 1; 
    clearText()
    unHighlight()
  } else if (game == 1) {
    game = 0; 
    screens[1] = originalScreen
    addText("Super Tic Tac Toe!", { 
      x: 1,
      y: 7,
      color: color`3`
    })
    addText("Press J to Start", { 
      x: 2,
      y: 9,
      color: color`1`
    })
    unHighlight()
  } else if (game == 2) {
    game = 0;
    clearText()
    addText("Super Tic Tac Toe!", { 
      x: 1,
      y: 7,
      color: color`3`
    })
    addText("Press J to Start", { 
      x: 2,
      y: 9,
      color: color`1`
    })
    unHighlight()
  }
  setMap(screens[game])

  // Reset game control variables
  highlightedX = 2
  highlightedY = 2
  squareX = 2
  squareY = 2
  selectingSquare = false
  canPlace = true
  locked = false
  grid = [[0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0], 
          [0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0], 
          [0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0]]
  player = 'x'

  if (game == 1) {
    highlightBox(highlightedX, highlightedY)
  }
});